---
layout: post
title: MySQL InnoDB中的索引
categories: [MySQL]
description: MySQL InnoDB中的索引
keywords: MySQL, InnoDB, 索引
---

### 聚簇索引和二级索引

每个InnoDB表都有一个特殊的索引，称为聚簇索引，存储整行数据。通常，主键就是聚簇索引。为了在查询、插入和一些其他的操作中获取最好的性能，理解InnoDB是如何利用聚簇索引来优化普通查询和DML操作是很重要的。

- 当你定义了一个主键，InnoDB使用这个主键作为聚簇索引。每个表都应该定义一个主键。如果没有唯一且非空的列可以作为主键，可以定义一个自增列作为主键。

- 如果你不定义主键，InnoDB会使用第一个唯一的非空的列作为聚簇索引。
- 如果表中没有适合作为聚簇索引的列，InnoDB在合成列上生成一个隐藏的聚簇索引，索引的名字为GEN_CLUST_INDEX，这个合成列包含了一个行ID值。数据是按照行ID排序的。行ID为6个字节大小，是单调递增的。因此数据的排序就是插入的顺序。

### 聚簇索引如何提升查询速度

通过聚簇索引查询快是因为聚簇索引查找直接指向包含数据的页。如果表很大，能够节省磁盘I/O，相比那些将行数据存储在不同的数据页中的存储方式。

### 二级索引是如何关联聚簇索引的

聚簇索引以外的索引称为二级索引。在InnoDB中，二级索引的每个记录中除了包含了二级索引的值，还包含对应行的主键值。InnoDB使用这个主键去查找聚簇索引。

如果聚簇索引比较大，二级索引将会占用更大的空间，所以使用较小的主键索引具有一定的好处。

### InnoDB索引的物理的结构

除了空间索引，InnoDB索引采用的是B-tree数据结构。空间索引使用的R-tree，是一种用来索引多维数据的特殊数据结构。索引记录存储在B-tree和R-tree的叶子节点数据页中。默认的索引页的大小是16KB，通过`innodb_page_size`设置数据页的大小。

当向InnoDB聚簇索引插入新的数据时，InnoDB尽量预留数据页1/16的空间用来以后索引记录的插入和更新操作。如果索引记录是顺序插入的（升序或者降序），索引页的空间将维持在15/16。如果记录是随机插入的，索引页的空间将维持在1/2到15/16之间。

当创建或者重建索引时，InnoDB会执行批量加载。创建索引的方式是将索引数据排序，创建排序索引。`innodb_fill_factor`定义索引创建时B-tree数据页空间的占用百分比，剩下空间预留给索引的增长。空间索引不支持创建排序索引。

如果InnoDB的填充因子低于MERGE_THRESHOLD（默认为50%），InnoDB会尝试收缩索引树来释放空闲的数据页。MERGE_THRESHOLD参数对B-tree和R-tree索引都有效。