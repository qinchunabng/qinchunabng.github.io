---
layout: post
title: C语言中的静态库和动态库的实现
categories: [C]
description: C语言中的静态库和动态库的实现
keywords: C, 静态库, 动态库
---

## C语言中的库

C语言中库就是一个二进制文件，包含了一些复用函数的封装。比如在头文件中包含`stdio.h`，就是标准IO的库，包含了`stdio.h`就相对当于IO相关函数声明和定义。为什么包含了头文件就能找到相关的库？因为相关的库文件已经提前放在特定事务目录下，在`/usr/include`目录下包含一些常见库以及其头文件。除了在标准库的include目录可以查看库的内容，我们还可以通过man手册可以库的详细信息，包含库中的一些函数的声明等信息，例如可以通过命令`man string.h`查看string库的相关信息。

库分为两种：
- 静态库。
  静态库可以不在标准的位置，可以自己指明位置。静态库在编译的时候就会转载进来，在调用的时候就不占用运行时间。换句话说，静态库可能会造成代码膨胀，但是不影响运行和调用的时间。

- 动态库。
  动态库是指定的位置，动态库也叫共享库，放在指定目录，大家都可以使用。动态库在声明的时候只是引用了库，在执行的时候才会查找库并加载库。在程序中用到库中某个函数，才会到动态库相应的位置进行调用，占用的是运行时间，而不是编译时间。

### 静态库

静态库的名称都是libxx.a形式，xx是库名。通过如下命令创建静态库：
```
ar -cr libxx.a yyy.o
```
生成库文件之后，将.h文件放到/usr/local/include目录中，将库文件文件放到/usr/local/lib。使用时通过如下命令：
```
gcc -L/usr/local/lib -o main main.o -lxx
```
- 如果库文件时在/usr/local/lib目录下，-L选项可以省略
- -l参数必须放在最后，xx为库的名字




### 动态库

动态库的名字都是叫libxx.so，xx为动态库的名字。lib为固定的前缀，.os为后缀。生成动态库的命令：
```
gcc -shared -fPIC -o libxx.so yyy.c
```
- PIC可以小写。
- 同样地将头文件放到/usr/local/include目录，将.so文件放到/usr/local/lib中。
- 在/etc/ld.so.conf添加路径，这样即使库文件的路径不是在标准的路径中也能读得到。修改之后执行/sbin/ldconfig重读配置文件。

在编译的时候通过如下命令使用动态库：
```
gcc -I/usr/local/include -L/usr/local/lib -o ... -lxx
```
- -I指定头文件所在的位置，如果头文件位于/usr/local/include标准路径可以省略
- -L指定库文件路径，如果库文件位于/usr/local/lib这样的标准路径，可以省略
- -l指定动态库，xx为库名，依赖了多个库，需要通过多个-l指定
  
可以通过ldd命令打印使用的动态库。如果动态库和静态库同名，会优先使用动态库，这是由内核决定的。如果是非root用户发布库文件，可以先将库文件拷贝到指定目录，并定义LD_LIBRARY_PATH环境变量：
```
cp xxx.so ~/lib
export LD_LIBRARY_PATH=~/lib
```

另外，除非是标准库，否则-l不可以省略。