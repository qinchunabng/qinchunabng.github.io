---
layout: post
title: 记一次跟kafka相关的生产故障
categories: [java]
description: 生产事故问题分析
keywords: java, kafka
---

最近生产环境遇到一个问题，觉得这个问题还是挺典型的，所以就把这个问题给记录下来。

### 问题现象
前几天，很多用户反馈App登录不上，后经查询服务端日志，发现很多数据库锁等待超时的异常。经过运维检查，服务器CPU占用很高，达到百分之九十多，而且有150w个回滚事务在执行。

### 原因分析

分析服务器日志，根据异常堆栈信息定位到代码位置，经过分析代码，大致分析原因为如下：

客户端在登录操作之后，会发送一个登录成功的kafka消息，在kafka监听消费消息，异步处理，更新账号相关的登录信息，提高登录接口的响应速度。正常情况下，消息中包含有登录的设备唯一拥有的设备ID，服务端根据这个设备ID从数据根据设备ID查询出符合条件的数据然后再更新，但是由于偶然的原因客户端传过来的设备ID是一个空字符，导致查询会整表数据再去执行了update操作，而且update语句查询条件没有建立索引，会导致锁表。并且在早上上班高峰期，会有大量用户执行登录操作，就导致很多数据库操作获取不到锁而超时。并且这些操作都是在kafka监听中处理的，消费失败会导致重复消费，以致大量的数据库操作把数据资源耗尽。

**原因总结：不合理的数据库操作导致锁表，kafka消费失败重试导致不合理的数据库操作累积，耗尽数据库资源。**

### 解决办法

